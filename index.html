<!DOCTYPE html>
<meta charset=UTF-8>
<title>Datalunch</title>
<style>
  body {
    font-size: 16px;
  }
  section{
    display: flex;
  }
  ul.categories,
  ul.fiches {
    display: flex;
    flex-direction: column;
    padding: .5em;
    list-style: none;
    border: 1px solid grey;
  }
  ul.categories{
    font-size: 1.5em;
    width: 8em;
  }
  ul.fiches{
    width: 20em;
    margin: 0 2em;
  }
</style>

<section class=container>
  <ul class=categories></ul>
  <ul class=fiches></ul>
</section>

<template name=categories>
    <li><a href=# data-cat=title></a></li>
</template>

<template name=fiches>
    <li><a href=# data-fiche=title></a></li>
</template>

<script>
  const onHashChange = evt => importFiles()
    .then(json => {
      const container = document.querySelector('.fiches')
      const hash = evt.newURL.substring(evt.newURL.indexOf('#')+1, evt.newURL.length)
      displayFilesByCategorie(container, json.body, hash)
    })

  window.addEventListener("hashchange", onHashChange)

  const getCategories = files => files
    .filter(file => file.meta) //if file a des meta
    .map(file => file.meta.categorie) // renvoie la categorie
    .filter((elt, pos, arr) => arr.indexOf(elt) === pos) // supprime les doublons en testant la position des éléments
    .sort()

  const importFiles = () => fetch('https://api.daktary.com/infolab-cd33/datalunch-/tree/master/fiches')
    .then(response => response.json())

  const getTplLi = tplName =>
    document
      .querySelector(`template[name=${tplName}]`)
      .cloneNode(true)
      .content
      .querySelector('li')

  const displayCategories = (container, categories) => {
    categories.forEach(category => {
      const tpl = getTplLi('categories')
      const tplTitle = tpl.querySelector('[data-cat=title]')
      tplTitle.href = '#' + category
      tplTitle.append(category)
      container.append(tpl)
    })
  }

  const displayFilesByCategorie = (container, files, categorie) => {
    container.innerHTML = ''
    files
      .filter(file => file.meta)
      .filter(file => file.meta.categorie === categorie)
      .forEach(file => {
        const tpl = getTplLi('fiches')
        const tplTitle = tpl.querySelector('[data-fiche=title]')
        tplTitle.href = file.url
        tplTitle.append(file.meta.title)
        container.append(tpl)
      })
  }

  importFiles().then(json => {
    const container = document.querySelector('.categories')
    const categories = getCategories(json.body)
    displayCategories(container, categories)
  })


</script>
